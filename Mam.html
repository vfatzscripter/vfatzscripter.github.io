<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI Art Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .toolbar {
            background-color: #333;
            color: white;
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .toolbar button {
            background-color: #555;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
        }
        .toolbar button:hover {
            background-color: #777;
        }
        canvas {
            border: 1px solid #ccc;
            display: block;
            margin: 10px auto;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <button id="circle">Circle</button>
        <button id="rectangle">Rectangle</button>
        <button id="play">Play MIDI</button>
        <button id="clear">Clear</button>
    </div>
    <canvas id="midiCanvas" width="800" height="400"></canvas>
    <script>
        const canvas = document.getElementById("midiCanvas");
        const ctx = canvas.getContext("2d");

        let shapes = []; // Store shapes as MIDI events
        let currentTool = null;

        document.getElementById("circle").addEventListener("click", () => {
            currentTool = "circle";
        });

        document.getElementById("rectangle").addEventListener("click", () => {
            currentTool = "rectangle";
        });

        document.getElementById("clear").addEventListener("click", () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            shapes = [];
        });

        document.getElementById("play").addEventListener("click", playMIDI);

        canvas.addEventListener("mousedown", (event) => {
            const rect = canvas.getBoundingClientRect();
            const startX = event.clientX - rect.left;
            const startY = event.clientY - rect.top;

            canvas.addEventListener(
                "mouseup",
                (event) => {
                    const endX = event.clientX - rect.left;
                    const endY = event.clientY - rect.top;

                    if (currentTool === "circle") {
                        const radius = Math.sqrt(
                            Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2)
                        );
                        ctx.beginPath();
                        ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
                        ctx.stroke();
                        shapes.push({
                            type: "circle",
                            x: startX,
                            y: startY,
                            radius,
                            midiNote: Math.floor(radius % 128), // Map radius to a MIDI note
                        });
                    } else if (currentTool === "rectangle") {
                        const width = endX - startX;
                        const height = endY - startY;
                        ctx.strokeRect(startX, startY, width, height);
                        shapes.push({
                            type: "rectangle",
                            x: startX,
                            y: startY,
                            width,
                            height,
                            midiNote: Math.floor(Math.abs(width) % 128), // Map width to a MIDI note
                        });
                    }
                },
                { once: true }
            );
        });

        // Function to play MIDI events
        async function playMIDI() {
            if (navigator.requestMIDIAccess) {
                const midiAccess = await navigator.requestMIDIAccess();
                const outputs = Array.from(midiAccess.outputs.values());
                if (outputs.length === 0) {
                    alert("No MIDI output device found.");
                    return;
                }
                const output = outputs[0];

                // Play shapes as MIDI events
                for (const shape of shapes) {
                    const note = shape.midiNote;
                    const velocity = 100; // Fixed velocity
                    output.send([0x90, note, velocity]); // Note on
                    await new Promise((resolve) =>
                        setTimeout(resolve, 500) // Delay for playback
                    );
                    output.send([0x80, note, 0]); // Note off
                }
            } else {
                alert("Web MIDI API not supported in this browser.");
            }
        }
    </script>
</body>
</html>
